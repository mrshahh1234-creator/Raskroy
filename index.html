<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mustafayev Academy | BAZIS Pro Terminal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --accent: #10b981;
            --blue: #3b82f6;
            --text: #f8fafc;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg); color: var(--text);
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        header {
            padding: 15px 40px; background: var(--panel);
            border-bottom: 2px solid var(--accent);
            display: flex; justify-content: space-between; align-items: center;
        }

        .controls {
            padding: 15px 40px; background: rgba(30, 41, 59, 0.5);
            display: flex; gap: 20px; align-items: center;
        }

        .btn-load {
            background: var(--blue); color: white; padding: 12px 24px;
            border-radius: 8px; cursor: pointer; font-weight: bold; border: none;
        }

        /* –ó–æ–Ω–∞ —Ä–∞—Å–∫—Ä–æ—è */
        .workspace {
            flex: 1; padding: 40px; overflow: auto;
            display: flex; flex-direction: column; align-items: center; gap: 40px;
        }

        .sheet-container {
            position: relative; background: #334155;
            border: 2px solid #64748b; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .part {
            position: absolute; background: #475569;
            border: 1px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.1s; font-size: 11px;
            overflow: hidden; box-sizing: border-box;
        }

        .part:hover { background: var(--blue); z-index: 10; transform: scale(1.02); }
        .part.is-cut { background: var(--accent) !important; opacity: 0.5; }

        footer {
            padding: 15px 40px; text-align: right;
            background: var(--panel); font-size: 18px;
        }
        footer b { color: var(--accent); }

        /* –°–¢–ò–õ–ò –ü–ï–ß–ê–¢–ò (–ë–ò–†–ö–ê) */
        @media print {
            .no-print { display: none !important; }
            #print-area { display: block !important; }
            @page { margin: 0; }
        }

        #print-area {
            display: none; width: 80mm; height: 50mm;
            background: white; color: black; padding: 10px;
            box-sizing: border-box; font-family: Arial, sans-serif;
        }

        .label-grid { display: grid; grid-template-columns: 1fr 90px; height: 100%; }
        .label-info h2 { margin: 0; font-size: 14pt; }
        .label-info h1 { margin: 5px 0; font-size: 22pt; font-weight: 900; }
        .edge-indicator {
            width: 50px; height: 35px; border: 1px solid #000;
            position: relative; margin-top: 5px;
        }
        .edge-active { border-width: 4px !important; }
    </style>
</head>
<body>

<header class="no-print">
    <h1>MUSTAFAYEV FACTORY <span style="font-size: 12px; opacity: 0.6;">| –í–ï–†–°–ò–Ø 3.0 (QR + –ë–ê–ó–ò–°)</span></h1>
    <div id="clock" style="font-family: monospace;"></div>
</header>

<div class="controls no-print">
    <label class="btn-load">üì• –ó–ê–ì–†–£–ó–ò–¢–¨ –ü–†–û–ï–ö–¢ (.XML)
        <input type="file" id="fileInput" accept=".xml" style="display:none" onchange="processFile(event)">
    </label>
    <div id="file-status" style="color: var(--accent)">–û–∂–∏–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...</div>
</div>

<div class="workspace no-print" id="workspace">
    <div style="opacity: 0.3; font-size: 24px; margin-top: 100px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ XML –∏–∑ –ë–∞–∑–∏—Å–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</div>
</div>

<footer class="no-print">
    Mustafayev <b>Academy</b>
</footer>

<div id="print-area">
    <div class="label-grid">
        <div class="label-info">
            <div style="font-size: 8pt; border-bottom: 1px solid #000; margin-bottom: 5px;">MUSTAFAYEV ACADEMY</div>
            <h2 id="p-name">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</h2>
            <h1 id="p-size">000 x 000</h1>
            <div id="p-mat" style="font-size: 9pt; color: #333;">–ú–∞—Ç–µ—Ä–∏–∞–ª</div>
            <div class="edge-indicator" id="p-edges"></div>
            <div style="font-size: 7pt; margin-top: 5px;" id="p-date"></div>
        </div>
        <div id="qrcode" style="display: flex; align-items: flex-end; justify-content: flex-end;"></div>
    </div>
</div>

<script>
    // –ß–∞—Å—ã
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleString(); }, 1000);

    const SCALE = 0.35; // –ú–∞—Å—à—Ç–∞–± –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–ª–∏—Ç

    function processFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        document.getElementById('file-status').innerText = "–§–∞–π–ª: " + file.name;

        const reader = new FileReader();
        reader.onload = function(e) {
            const parser = new DOMParser();
            const xml = parser.parseFromString(e.target.result, "text/xml");
            renderPanels(xml);
        };
        reader.readAsText(file);
    }

    function renderPanels(xml) {
        const workspace = document.getElementById('workspace');
        workspace.innerHTML = '';
        
        // –í –ë–∞–∑–∏—Å–µ –ø–ª–∏—Ç—ã ‚Äî —ç—Ç–æ —Ç–µ–≥–∏ panel0, panel1...
        const panels = xml.querySelectorAll('[material]');

        panels.forEach((panel, index) => {
            const L = parseFloat(panel.getAttribute('l'));
            const W = parseFloat(panel.getAttribute('w'));
            const mat = panel.getAttribute('material');

            const container = document.createElement('div');
            container.className = 'sheet-container';
            container.style.width = (L * SCALE) + 'px';
            container.style.height = (W * SCALE) + 'px';
            container.innerHTML = `<div style="position:absolute; top:-25px; color:var(--accent)">–ü–õ–ò–¢–ê ${index+1}: ${mat}</div>`;

            // –ò—â–µ–º –¥–µ—Ç–∞–ª–∏ –≤–Ω—É—Ç—Ä–∏ –ø–ª–∏—Ç—ã
            const parts = panel.children;
            for(let p of parts) {
                const pL = parseFloat(p.getAttribute('l'));
                const pW = parseFloat(p.getAttribute('w'));
                const pX = parseFloat(p.getAttribute('x'));
                const pY = parseFloat(p.getAttribute('y'));
                const pId = p.getAttribute('id');

                if (pL && pW) {
                    const div = document.createElement('div');
                    div.className = 'part';
                    div.style.left = (pX * SCALE) + 'px';
                    div.style.top = (pY * SCALE) + 'px';
                    div.style.width = (pL * SCALE) + 'px';
                    div.style.height = (pW * SCALE) + 'px';
                    
                    if (pL * SCALE > 30) div.innerText = pL + 'x' + pW;

                    div.onclick = () => generateLabel({
                        name: "–î–µ—Ç–∞–ª—å #" + pId,
                        size: pL + " x " + pW,
                        material: mat,
                        id: pId
                    }, div);

                    container.appendChild(div);
                }
            }
            workspace.appendChild(container);
        });
    }

    function generateLabel(data, element) {
        // –û—Ç–º–µ—á–∞–µ–º –¥–µ—Ç–∞–ª—å –∫–∞–∫ –æ—Ç—Ä–µ–∑–∞–Ω–Ω—É—é
        element.classList.add('is-cut');

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–∏—Ä–∫–∏
        document.getElementById('p-name').innerText = data.name;
        document.getElementById('p-size').innerText = data.size;
        document.getElementById('p-mat').innerText = data.material;
        document.getElementById('p-date').innerText = new Date().toLocaleDateString();

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR
        const qrContainer = document.getElementById('qrcode');
        qrContainer.innerHTML = '';
        new QRCode(qrContainer, {
            text: "PART_ID:" + data.id + "|SIZE:" + data.size,
            width: 85, height: 85,
            colorDark : "#000000",
            colorLight : "#ffffff"
        });

        // –ü–µ—á–∞—Ç—å
        setTimeout(() => { window.print(); }, 250);
    }
</script>
</body>
</html>
