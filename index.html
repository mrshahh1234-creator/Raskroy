<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Mustafayev Academy | Production</title>
    <style>
        :root { --accent: #2ecc71; --bg: #0f1215; --card: #1c2227; --text: #e0e6ed; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* –®–∞–ø–∫–∞ */
        .header { background: #1a1a1a; padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid var(--accent); }
        .logo { font-size: 20px; font-weight: bold; text-transform: uppercase; }
        .logo span { color: var(--accent); }
        .btn-load { background: var(--accent); color: #000; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; border-radius: 6px; }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç */
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–µ—Ç–∞–ª–∏ */
        .card { 
            background: var(--card); border: 1px solid #333; border-radius: 12px; padding: 15px; 
            cursor: pointer; position: relative; transition: 0.2s;
        }
        .card:hover { border-color: var(--accent); background: #252b33; }
        .p-name { font-size: 14px; color: #888; margin-bottom: 8px; }
        .p-size { font-size: 32px; font-weight: bold; }
        .icons { position: absolute; top: 15px; right: 15px; font-size: 20px; }
        .click-hint { font-size: 10px; color: var(--accent); margin-top: 10px; font-weight: bold; }

        /* –°—Ç–∏–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª–µ—Ç—è—Ç –Ω–∞ –ø—Ä–∏–Ω—Ç–µ—Ä (–≤–Ω—É—Ç—Ä–∏ Iframe) */
        #print-template { display: none; }
    </style>
</head>
<body>

<div class="header">
    <div class="logo">MUSTAFAYEV <span>ACADEMY</span></div>
    <div>
        <input type="file" id="fileInput" style="display:none" accept=".project">
        <button class="btn-load" onclick="document.getElementById('fileInput').click()">–ó–ê–ì–†–£–ó–ò–¢–¨ .PROJECT</button>
    </div>
</div>

<div class="main">
    <div id="grid" class="grid"></div>
</div>

<div id="print-template">
    <div style="width: 54mm; font-family: Arial, sans-serif; color: black; padding: 2mm;">
        <div style="text-align: center; font-weight: bold; border-bottom: 1px solid black; margin-bottom: 2mm; font-size: 10pt;">
            MUSTAFAYEV ACADEMY
        </div>
        <div id="tpl-project" style="font-size: 8pt;"></div>
        <div id="tpl-name" style="font-size: 11pt; font-weight: bold; margin: 1mm 0;"></div>
        <div id="tpl-mat" style="font-size: 8pt; margin-bottom: 2mm;"></div>
        
        <div id="tpl-box" style="border: 1px solid #ccc; text-align: center; padding: 5mm 0; font-size: 26pt; font-weight: bold;">
            <span id="tpl-size"></span>
        </div>

        <div style="display: flex; justify-content: space-between; margin-top: 2mm; border-top: 1px solid black; padding-top: 1mm;">
            <div id="tpl-edge" style="font-size: 8pt; width: 70%;"></div>
            <div id="tpl-icons" style="font-size: 14pt;"></div>
        </div>
    </div>
</div>

<script>
    let queue = [];
    let projData = { name: "", mat: "", edge: "" };

    document.getElementById('fileInput').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(ev) {
            const parser = new DOMParser();
            const xml = parser.parseFromString(ev.target.result, "text/xml");
            
            projData.name = xml.querySelector("good[typeId='product']")?.getAttribute("name") || "–ó–∞–∫–∞–∑";
            projData.mat = xml.querySelector("good[typeId='sheet']")?.getAttribute("name") || "–õ–î–°–ü";
            projData.edge = xml.querySelector("good[typeId='band']")?.getAttribute("name") || "–ö—Ä–æ–º–∫–∞";

            const tech = {};
            const ops = xml.getElementsByTagName("operation");
            for (let op of ops) {
                if (op.getAttribute("typeId") === "XNC") {
                    const isB = (op.getAttribute("program") || "").includes("Bore");
                    const isM = (op.getAttribute("program") || "").includes("Mill");
                    const pRefs = op.getElementsByTagName("part");
                    for (let r of pRefs) {
                        const id = r.getAttribute("id");
                        if (!tech[id]) tech[id] = { b: false, m: false };
                        if (isB) tech[id].b = true;
                        if (isM) tech[id].m = true;
                    }
                }
            }

            queue = [];
            const parts = xml.getElementsByTagName("part");
            for (let p of parts) {
                if (p.parentNode.nodeName === "good" && p.hasAttribute("dl")) {
                    const id = p.getAttribute("id");
                    const count = parseInt(p.getAttribute("count")) || 1;
                    for (let c = 0; c < count; c++) {
                        queue.push({
                            id: id,
                            name: p.getAttribute("name"),
                            l: Math.round(parseFloat(p.getAttribute("dl"))),
                            w: Math.round(parseFloat(p.getAttribute("dw"))),
                            edge: { t: p.hasAttribute("elt"), b: p.hasAttribute("elb"), l: p.hasAttribute("ell"), r: p.hasAttribute("elr") },
                            bore: tech[id]?.b || false, mill: tech[id]?.m || false
                        });
                    }
                }
            }
            render();
        };
        reader.readAsText(file, "windows-1251");
    };

    function render() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        queue.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="icons">${item.bore ? 'üî©' : ''} ${item.mill ? 'üåÄ' : ''}</div>
                <div class="p-name">${item.name}</div>
                <div class="p-size">${item.l} √ó ${item.w}</div>
                <div class="click-hint">–ü–ï–ß–ê–¢–¨</div>
            `;
            card.onclick = () => printPart(index);
            grid.appendChild(card);
        });
    }

    function printPart(index) {
        const item = queue[index];
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —à–∞–±–ª–æ–Ω
        document.getElementById('tpl-project').innerText = "–ü—Ä–æ–µ–∫—Ç: " + projData.name;
        document.getElementById('tpl-name').innerText = item.name;
        document.getElementById('tpl-mat').innerText = "–ú–∞—Ç: " + projData.mat;
        document.getElementById('tpl-size').innerText = `${item.l} x ${item.w}`;
        document.getElementById('tpl-icons').innerText = (item.bore ? 'üî©' : '') + (item.mill ? ' üåÄ' : '');
        
        const hasEdge = (item.edge.t || item.edge.b || item.edge.l || item.edge.r);
        document.getElementById('tpl-edge').innerText = hasEdge ? "–ö—Ä–æ–º–∫–∞: " + projData.edge : "";

        const box = document.getElementById('tpl-box');
        box.style.borderTop = item.edge.t ? "6pt solid black" : "1pt solid #ccc";
        box.style.borderBottom = item.edge.b ? "6pt solid black" : "1pt solid #ccc";
        box.style.borderLeft = item.edge.l ? "6pt solid black" : "1pt solid #ccc";
        box.style.borderRight = item.edge.r ? "6pt solid black" : "1pt solid #ccc";

        // –ü–ï–ß–ê–¢–¨ –ß–ï–†–ï–ó IFRAME (—Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –ø—É—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞)
        const iframe = document.createElement('iframe');
        iframe.style.position = 'fixed';
        iframe.style.right = '100%';
        iframe.style.bottom = '100%';
        document.body.appendChild(iframe);
        
        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write('<html><body style="margin:0;">' + document.getElementById('print-template').innerHTML + '</body></html>');
        doc.close();

        setTimeout(() => {
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
            document.body.removeChild(iframe);
            
            // –£–¥–∞–ª—è–µ–º –∏–∑ –æ—á–µ—Ä–µ–¥–∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞ –ø–µ—á–∞—Ç–∏
            queue.splice(index, 1);
            render();
        }, 500);
    }
</script>
</body>
</html>
