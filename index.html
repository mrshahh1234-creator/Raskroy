<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Mustafayev Academy | –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º</title>
    <style>
        :root { --accent: #2ecc71; --bg: #121212; --card: #1e1e1e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* –®–∞–ø–∫–∞ Mustafayev Academy */
        .header { background: #1a1a1a; padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; border-bottom: 3px solid var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .logo { font-size: 20px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .logo span { color: var(--accent); }
        .btn-load { background: var(--accent); color: #000; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; border-radius: 4px; transition: 0.2s; }
        .btn-load:hover { background: #27ae60; transform: scale(1.02); }

        .container { flex: 1; padding: 20px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card { 
            background: var(--card); border: 1px solid #333; border-radius: 8px; padding: 15px; 
            cursor: pointer; position: relative; transition: 0.2s;
        }
        .card:hover { border-color: var(--accent); background: #252525; }
        .p-name { font-size: 13px; color: #888; margin-bottom: 5px; height: 35px; overflow: hidden; }
        .p-size { font-size: 30px; font-weight: bold; color: #fff; }
        .icons-box { position: absolute; top: 10px; right: 10px; font-size: 20px; display: flex; gap: 5px; }

        /* –≠—Ç–∏–∫–µ—Ç–∫–∞ –Ω–∞ –ø–µ—á–∞—Ç—å (58–º–º) */
        @media print {
            body * { display: none; }
            #print-area { display: block !important; width: 58mm; color: black; font-family: 'Arial', sans-serif; padding: 1mm; }
            .pr-header { font-size: 9pt; font-weight: bold; border-bottom: 1px solid #000; padding-bottom: 2px; margin-bottom: 4px; text-align: center; }
            .pr-project { font-size: 7pt; margin-bottom: 2px; }
            .pr-name { font-size: 10pt; font-weight: bold; margin-bottom: 2px; white-space: nowrap; overflow: hidden; }
            .pr-mat { font-size: 7pt; margin-bottom: 4px; border-bottom: 0.5px solid #ccc; padding-bottom: 2px; }
            
            .size-box { 
                font-size: 24pt; font-weight: bold; text-align: center; margin: 4px 0; padding: 4px;
                border: 1px solid #ddd; position: relative;
            }
            /* –ö—Ä–æ–º–∫–∞ –∂–∏—Ä–Ω—ã–º–∏ –ª–∏–Ω–∏—è–º–∏ */
            .edge-t { border-top: 5px solid #000 !important; }
            .edge-b { border-bottom: 5px solid #000 !important; }
            .edge-l { border-left: 5px solid #000 !important; }
            .edge-r { border-right: 5px solid #000 !important; }

            .pr-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 4px; }
            .edge-text { font-size: 7pt; line-height: 1; max-width: 70%; }
            .tech-icons { font-size: 14pt; }
            .academy-mark { font-size: 6pt; text-align: center; margin-top: 5px; color: #666; font-style: italic; }
        }
        #print-area { display: none; }
    </style>
</head>
<body>

<div class="header">
    <div class="logo">MUSTAFAYEV <span>ACADEMY</span></div>
    <div style="display: flex; gap: 20px; align-items: center;">
        <div id="stats" style="font-size: 14px; color: #888;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ .project</div>
        <input type="file" id="fileInput" style="display:none" accept=".project">
        <button class="btn-load" onclick="document.getElementById('fileInput').click()">–û–¢–ö–†–´–¢–¨ –§–ê–ô–õ</button>
    </div>
</div>

<div class="container">
    <div id="grid" class="grid"></div>
</div>

<div id="print-area">
    <div class="pr-header">Mustafayev Academy</div>
    <div class="pr-project" id="lbl-project">-</div>
    <div class="pr-name" id="lbl-name">-</div>
    <div class="pr-mat" id="lbl-mat">-</div>
    
    <div id="lbl-size-box" class="size-box">
        <span id="lbl-size">0 x 0</span>
    </div>

    <div class="pr-footer">
        <div class="edge-text" id="lbl-edge-name"></div>
        <div class="tech-icons" id="lbl-icons"></div>
    </div>
    <div class="academy-mark">Quality furniture system</div>
</div>

<script>
    let queue = [];
    let projectTitle = "";
    let mainMaterial = "";
    let edgeMaterial = "";

    document.getElementById('fileInput').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(ev) {
            const parser = new DOMParser();
            const xml = parser.parseFromString(ev.target.result, "text/xml");
            
            // 1. –ü–æ–ª—É—á–∞–µ–º –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            projectTitle = xml.querySelector("good[typeId='product']")?.getAttribute("name") || "–ó–∞–∫–∞–∑";
            mainMaterial = xml.querySelector("good[typeId='sheet']")?.getAttribute("name") || "–õ–î–°–ü";
            edgeMaterial = xml.querySelector("good[typeId='band']")?.getAttribute("name") || "";

            // 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∏—Å–∞–¥–∫—É –∏ —Ñ—Ä–µ–∑–µ—Ä–æ–≤–∫—É –ø–æ ID –¥–µ—Ç–∞–ª–µ–π
            const techMap = {};
            const operations = xml.getElementsByTagName("operation");
            for (let op of operations) {
                if (op.getAttribute("typeId") === "XNC") {
                    const prog = op.getAttribute("program") || "";
                    const hasBore = prog.includes("Bore");
                    const hasMill = prog.includes("Mill") || prog.includes("mac"); // mac - —ç—Ç–æ –¥—É–≥–∏
                    
                    const partRefs = op.getElementsByTagName("part");
                    for (let ref of partRefs) {
                        const pid = ref.getAttribute("id");
                        if (!techMap[pid]) techMap[pid] = { b: false, m: false };
                        if (hasBore) techMap[pid].b = true;
                        if (hasMill) techMap[pid].m = true;
                    }
                }
            }

            // 3. –°–æ–±–∏—Ä–∞–µ–º –æ—á–µ—Ä–µ–¥—å –¥–µ—Ç–∞–ª–µ–π
            queue = [];
            const parts = xml.getElementsByTagName("part");
            for (let p of parts) {
                // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –¥–µ—Ç–∞–ª–∏ –∏–∑ —Ä–∞–∑–¥–µ–ª–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ª–∏—Å—Ç—ã –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏)
                if (p.parentNode.nodeName === "good" && p.hasAttribute("dl")) {
                    const id = p.getAttribute("id");
                    const count = parseInt(p.getAttribute("count")) || 1;
                    for (let c = 0; c < count; c++) {
                        queue.push({
                            id: id,
                            name: p.getAttribute("name"),
                            l: Math.round(parseFloat(p.getAttribute("dl"))),
                            w: Math.round(parseFloat(p.getAttribute("dw"))),
                            edge: {
                                t: p.hasAttribute("elt"), b: p.hasAttribute("elb"),
                                l: p.hasAttribute("ell"), r: p.hasAttribute("elr")
                            },
                            hasBore: techMap[id]?.b || false,
                            hasMill: techMap[id]?.m || false
                        });
                    }
                }
            }
            render();
        };
        reader.readAsText(file, "windows-1251");
    };

    function render() {
        const grid = document.getElementById('grid');
        document.getElementById('stats').innerText = `–î–µ—Ç–∞–ª–µ–π –≤ —Ä–∞–±–æ—Ç–µ: ${queue.length}`;
        grid.innerHTML = '';

        if (queue.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#444; margin-top:100px;"><h2>–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞</h2></div>';
            return;
        }

        queue.forEach((p, i) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="icons-box">${p.hasBore ? 'üî©' : ''} ${p.hasMill ? 'üåÄ' : ''}</div>
                <div class="p-name">${p.name}</div>
                <div class="p-size">${p.l} √ó ${p.w}</div>
            `;
            card.onclick = () => printItem(i);
            grid.appendChild(card);
        });
    }

    function printItem(i) {
        const p = queue[i];
        
        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
        document.getElementById('lbl-project').innerText = `–ü—Ä–æ–µ–∫—Ç: ${projectTitle}`;
        document.getElementById('lbl-name').innerText = p.name;
        document.getElementById('lbl-mat').innerText = mainMaterial;
        document.getElementById('lbl-size').innerText = `${p.l} √ó ${p.w}`;
        
        // –ö—Ä–æ–º–∫–∞ (—Ç–µ–∫—Å—Ç)
        const isEdged = (p.edge.t || p.edge.b || p.edge.l || p.edge.r);
        document.getElementById('lbl-edge-name').innerText = isEdged ? `–ö—Ä–æ–º–∫–∞: ${edgeMaterial}` : "";

        // –ò–∫–æ–Ω–∫–∏
        document.getElementById('lbl-icons').innerText = `${p.hasBore ? 'üî©' : ''} ${p.hasMill ? 'üåÄ' : ''}`;

        // –†–∞–º–∫–∞ –∫—Ä–æ–º–∫–∏
        const box = document.getElementById('lbl-size-box');
        box.className = 'size-box';
        if (p.edge.t) box.classList.add('edge-t');
        if (p.edge.b) box.classList.add('edge-b');
        if (p.edge.l) box.classList.add('edge-l');
        if (p.edge.r) box.classList.add('edge-r');

        window.print();

        // –£–¥–∞–ª–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        queue.splice(i, 1);
        render();
    }
</script>

</body>
</html>
