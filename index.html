<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Mustafayev Academy | Integrated Post-Processor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --bg: #0b0f1a; --panel: #161e2e; --accent: #10b981; --blue: #3b82f6; --text: #f1f5f9;
        }
        body {
            font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text);
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }
        header {
            padding: 15px 30px; background: var(--panel); border-bottom: 2px solid var(--blue);
            display: flex; justify-content: space-between; align-items: center;
        }
        .main-container { display: grid; grid-template-columns: 1fr 400px; flex: 1; overflow: hidden; }
        
        /* –≠–∫—Ä–∞–Ω —Ä–∞—Å–∫—Ä–æ—è */
        .viewport { padding: 30px; overflow: auto; background: #000; display: flex; flex-direction: column; align-items: center; }
        .sheet { position: relative; background: #242f42; border: 1px solid #334155; margin-bottom: 40px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .part {
            position: absolute; background: rgba(59, 130, 246, 0.3); border: 1px solid rgba(255,255,255,0.2);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: 0.1s; font-size: 13px; font-weight: 700; color: white;
        }
        .part:hover { background: var(--blue); outline: 2px solid #fff; z-index: 5; }
        .part.cut { background: var(--accent) !important; opacity: 0.5; }

        /* –°–ø–∏—Å–æ–∫ –¥–µ—Ç–∞–ª–µ–π (–ü–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä) */
        .sidebar { background: var(--panel); border-left: 1px solid #1e293b; padding: 20px; overflow-y: auto; }
        .detail-row {
            background: #1f2937; margin-bottom: 8px; padding: 12px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
            border: 1px solid transparent;
        }
        .detail-row:hover { border-color: var(--blue); }
        .detail-id { background: var(--blue); padding: 4px 10px; border-radius: 4px; font-weight: 900; }

        /* –ö—Ä–æ–º–∫–∞ –Ω–∞ –±–∏—Ä–∫–µ */
        .edge-box { width: 50px; height: 35px; border: 1px solid #ccc; position: relative; margin: 5px 0; }
        .e-active { background: #000; position: absolute; }

        /* –ü–µ—á–∞—Ç—å */
        @media print { .no-print { display: none !important; } #print-label { display: block !important; } }
        #print-label {
            display: none; width: 80mm; height: 50mm; background: #fff; color: #000;
            padding: 8px; box-sizing: border-box; font-family: 'Arial Narrow', Arial;
        }
        .label-grid { display: grid; grid-template-columns: 1fr 100px; height: 100%; border: 1px solid #000; padding: 5px; }

        .btn { background: var(--blue); color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<header class="no-print">
    <div style="font-size: 20px; font-weight: 900; letter-spacing: 1px;">MUSTAFAYEV <span style="color:var(--accent)">ACADEMY</span></div>
    <label class="btn">üöÄ –ó–ê–ì–†–£–ó–ò–¢–¨ PROJECT
        <input type="file" id="projInput" style="display:none" onchange="processProject(event)">
    </label>
</header>

<div class="main-container no-print">
    <div class="viewport" id="viewport">
        <div style="margin-top:200px; color: var(--blue); font-size: 18px;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª .project —Å—é–¥–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏</div>
    </div>
    
    <div class="sidebar" id="sidebar">
        <h3 style="margin-top:0; color:var(--accent)">–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–µ—Ç–∞–ª–∏</h3>
        <div id="partsList"></div>
    </div>
</div>

<div id="print-label">
    <div class="label-grid">
        <div>
            <div style="font-size: 8pt; font-weight: bold; text-align: center; border-bottom: 1px solid #000;">MUSTAFAYEV ACADEMY</div>
            <div id="l-name" style="font-size: 10pt; margin: 4px 0; white-space: nowrap; overflow: hidden;">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
            <div id="l-size" style="font-size: 22pt; font-weight: 900; letter-spacing: -1px;">000 x 000</div>
            <div id="l-mat" style="font-size: 7pt; margin-bottom: 4px;">–ú–∞—Ç–µ—Ä–∏–∞–ª</div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div class="edge-box" id="l-edge-vis"></div>
                <div style="font-size: 7pt;">–ö—Ä–æ–º–∫–∞:<br><span id="l-edge-text">-</span></div>
            </div>
        </div>
        <div style="display: flex; flex-direction: column; justify-content: space-between; align-items: flex-end;">
            <div id="l-qr"></div>
            <div id="l-id" style="font-size: 14pt; font-weight: 900; border: 2px solid #000; padding: 0 5px;">‚Ññ1</div>
        </div>
    </div>
</div>

<script>
    const SCALE = 0.35;

    async function processProject(event) {
        const file = event.target.files[0];
        if (!file) return;

        const text = await file.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, "text/xml");

        renderApp(xml);
    }

    function renderApp(xml) {
        const viewport = document.getElementById('viewport');
        const partsList = document.getElementById('partsList');
        viewport.innerHTML = '';
        partsList.innerHTML = '';

        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –≤ —Ñ–∞–π–ª–µ .project
        const parts = xml.querySelectorAll('part');
        
        parts.forEach(p => {
            const id = p.getAttribute('id');
            const name = p.getAttribute('name');
            const l = p.getAttribute('dl');
            const w = p.getAttribute('dw');
            
            // –õ–æ–≥–∏–∫–∞ –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞: –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—Ä–æ–º–∫—É
            const edges = {
                t: p.getAttribute('elt') ? true : false,
                b: p.getAttribute('elb') ? true : false,
                l: p.getAttribute('ell') ? true : false,
                r: p.getAttribute('elr') ? true : false
            };

            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≤ —Å–ø–∏—Å–∫–µ
            const row = document.createElement('div');
            row.className = 'detail-row';
            row.innerHTML = `<span class="detail-id">${id}</span> <span>${name}</span> <b>${l}x${w}</b>`;
            
            // –ï—Å–ª–∏ –¥–µ—Ç–∞–ª—å –µ—Å—Ç—å –≤ —Ä–∞—Å–∫—Ä–æ–µ (—Å–∏–º—É–ª—è—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞)
            // –í —Ä–µ–∞–ª—å–Ω–æ–º .project –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ª–µ–∂–∞—Ç –≤ –±–ª–æ–∫–µ <cut> –∏–ª–∏ <layout>
            createPartOnCanvas(id, l, w, viewport, name, edges);

            row.onclick = () => printLabel({id, name, l, w, edges});
            partsList.appendChild(row);
        });
    }

    function createPartOnCanvas(id, l, w, container, name, edges) {
        // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é "–ø–ª–∏—Ç—É" –µ—Å–ª–∏ –µ—ë –µ—â–µ –Ω–µ—Ç
        if (!container.querySelector('.sheet')) {
            const sheet = document.createElement('div');
            sheet.className = 'sheet';
            sheet.style.width = (2750 * SCALE) + 'px';
            sheet.style.height = (1830 * SCALE) + 'px';
            container.appendChild(sheet);
        }
        
        const sheet = container.querySelector('.sheet');
        const div = document.createElement('div');
        div.className = 'part';
        div.style.width = (l * SCALE) + 'px';
        div.style.height = (w * SCALE) + 'px';
        
        // –°–ª—É—á–∞–π–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –±–µ—Ä–µ–º –∏–∑ XML)
        div.style.left = (Math.random() * 500) + 'px';
        div.style.top = (Math.random() * 300) + 'px';
        div.innerText = id;

        div.onclick = () => {
            div.classList.add('cut');
            printLabel({id, name: name, l, w, edges});
        };
        sheet.appendChild(div);
    }

    function printLabel(data) {
        document.getElementById('l-name').innerText = data.name;
        document.getElementById('l-size').innerText = `${data.l} x ${data.w}`;
        document.getElementById('l-mat').innerText = "–ü—Ä–æ–µ–∫—Ç: –í–∞–Ω–Ω–∞—è / –õ–î–°–ü 16–º–º";
        document.getElementById('l-id').innerText = "‚Ññ" + data.id;

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫—Ä–æ–º–∫–∏
        const vis = document.getElementById('l-edge-vis');
        vis.innerHTML = '';
        let etext = [];
        if(data.edges.t) { vis.innerHTML += '<div class="e-active" style="top:0; width:100%; height:3px;"></div>'; etext.push("–í–µ—Ä—Ö"); }
        if(data.edges.b) { vis.innerHTML += '<div class="e-active" style="bottom:0; width:100%; height:3px;"></div>'; etext.push("–ù–∏–∑"); }
        if(data.edges.l) { vis.innerHTML += '<div class="e-active" style="left:0; height:100%; width:3px;"></div>'; etext.push("–õ–µ–≤"); }
        if(data.edges.r) { vis.innerHTML += '<div class="e-active" style="right:0; height:100%; width:3px;"></div>'; etext.push("–ü—Ä–∞–≤"); }
        document.getElementById('l-edge-text').innerText = etext.length > 0 ? etext.join(", ") : "–ù–µ—Ç";

        // QR –ö–æ–¥
        const qrBox = document.getElementById('l-qr');
        qrBox.innerHTML = '';
        new QRCode(qrBox, { text: `PART:${data.id}|POS:02.01|SIZE:${data.l}x${data.w}`, width: 90, height: 90 });

        setTimeout(() => { window.print(); }, 200);
    }
</script>
</body>
</html>
