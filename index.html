<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Оператор: Раскрой GibLab</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .header { background: #333; padding: 10px 20px; display: flex; align-items: center; gap: 20px; border-bottom: 2px solid #ed1c24; }
        .btn-load { background: #ed1c24; color: white; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; border-radius: 4px; }
        .canvas-area { flex: 1; position: relative; overflow: auto; display: flex; justify-content: center; align-items: center; padding: 20px; }
        canvas { background: white; box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 1px solid #999; }
        
        /* Чек для печати */
        #print-zone { display: none; }
        @media print {
            body * { display: none; }
            #print-zone { display: block !important; width: 58mm; color: black; text-align: center; }
            .b-name { font-size: 16pt; font-weight: bold; }
            .b-info { font-size: 12pt; margin: 5px 0; }
        }
    </style>
</head>
<body>

<div class="header">
    <div style="font-size: 20px; font-weight: bold;">GibLab Monitor</div>
    <input type="file" id="loader" style="display:none" accept=".json,.js">
    <button class="btn-load" onclick="document.getElementById('loader').click()">ЗАГРУЗИТЬ ФАЙЛ ЭКСПОРТА</button>
    <div id="file-info">Файл не выбран</div>
</div>

<div class="canvas-area">
    <canvas id="view"></canvas>
</div>

<div id="print-zone">
    <div class="b-name" id="label-name">Деталь</div>
    <div class="b-info" id="label-size">000 x 000</div>
    <div class="b-info" id="label-mat">Материал</div>
    <div style="font-family: 'Code39'; font-size: 30px;">|||||||||||||</div>
</div>

<script>
    const canvas = document.getElementById('view');
    const ctx = canvas.getContext('2d');
    let parts = [];
    let scale = 0.35; // Коэффициент масштаба

    // Чтение файла
    document.getElementById('loader').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('file-info').innerText = file.name;

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                // Если скрипт Базиса выдает чистый JSON
                const data = JSON.parse(event.target.result);
                processData(data);
            } catch (err) {
                alert("Ошибка чтения: убедитесь, что это JSON файл");
            }
        };
        reader.readAsText(file);
    });

    function processData(data) {
        // Логика под ваш скрипт: ищем массив деталей
        // Если ваш скрипт упаковывает их в opCutSheets -> parts
        if (data.opCutSheets && data.opCutSheets[0].parts) {
            parts = data.opCutSheets[0].parts;
        } else if (Array.isArray(data)) {
            parts = data;
        }

        renderMap();
    }

    function renderMap() {
        // Установка размера плиты из конфига (например 2750x1830)
        canvas.width = 2750 * scale;
        canvas.height = 1830 * scale;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        parts.forEach(p => {
            // Рисуем деталь. ВАЖНО:PosX и PosY должны быть в вашем файле
            const x = (p.PosX || 0) * scale;
            const y = (p.PosY || 0) * scale;
            const w = (p.W || p.Width || 0) * scale;
            const h = (p.H || p.Height || 0) * scale;

            ctx.fillStyle = p.printed ? "#2ecc71" : "#3498db";
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = "white";
            ctx.lineWidth = 1;
            ctx.strokeRect(x, y, w, h);

            if (w > 30) {
                ctx.fillStyle = "white";
                ctx.font = "10px Arial";
                ctx.fillText(p.Name || "Деталь", x + 5, y + 15);
            }
        });
    }

    // Клик по холсту
    canvas.addEventListener('click', function(e) {
        const rect = canvas.getBoundingClientRect();
        const mx = (e.clientX - rect.left) / scale;
        const my = (e.clientY - rect.top) / scale;

        parts.forEach(p => {
            if (mx >= p.PosX && mx <= (p.PosX + p.W) && my >= p.PosY && my <= (p.PosY + p.H)) {
                p.printed = true;
                printItem(p);
                renderMap();
            }
        });
    });

    function printItem(p) {
        document.getElementById('label-name').innerText = p.Name || "Деталь";
        document.getElementById('label-size').innerText = `${Math.round(p.W)} x ${Math.round(p.H)}`;
        document.getElementById('label-mat').innerText = p.Material || "";
        window.print();
    }
</script>
</body>
</html>
