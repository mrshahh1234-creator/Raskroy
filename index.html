<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Mustafayev Academy Control</title>
    <style>
        :root { --accent: #2ecc71; --bg: #0f1215; --card-bg: #1c2227; --text: #e0e6ed; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–∞–π—Ç–∞ */
        .header { background: #1a1a1a; padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid var(--accent); }
        .logo { font-size: 20px; font-weight: bold; letter-spacing: 1px; }
        .logo span { color: var(--accent); }
        .btn-load { background: var(--accent); color: #000; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; border-radius: 6px; }
        
        .main-container { flex: 1; padding: 20px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        
        .card { 
            background: var(--card-bg); border: 1px solid #333; border-radius: 12px; padding: 15px; 
            cursor: pointer; position: relative; transition: 0.3s;
        }
        .card:hover { border-color: var(--accent); transform: translateY(-3px); background: #252b33; }
        .p-name { font-size: 14px; color: #888; margin-bottom: 5px; }
        .p-size { font-size: 32px; font-weight: bold; }
        .status-icons { position: absolute; top: 15px; right: 15px; font-size: 20px; }

        /* –ù–ê–°–¢–†–û–ô–ö–ê –ü–ï–ß–ê–¢–ò (58–º–º —Ç–µ—Ä–º–æ–ø—Ä–∏–Ω—Ç–µ—Ä) */
        @media print {
            @page { margin: 0; }
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { 
                position: absolute; left: 0; top: 0; width: 58mm; 
                padding: 2mm; color: #000 !important; background: #fff !important;
            }
            .pr-header { font-size: 10pt; font-weight: bold; border-bottom: 1pt solid #000; text-align: center; margin-bottom: 2mm; padding-bottom: 1mm;}
            .pr-info { font-size: 7pt; margin-bottom: 1mm; line-height: 1.1; }
            .pr-part-name { font-size: 10pt; font-weight: bold; margin: 1mm 0; }
            
            /* –í–∏–∑—É–∞–ª—å–Ω—ã–π –±–æ–∫—Å –¥–µ—Ç–∞–ª–∏ —Å –∫—Ä–æ–º–∫–æ–π */
            .size-box { 
                border: 1pt solid #ccc; margin: 2mm 0; padding: 3mm 0; 
                text-align: center; font-size: 24pt; font-weight: bold; position: relative;
            }
            .e-t { border-top: 5pt solid #000 !important; }
            .e-b { border-bottom: 5pt solid #000 !important; }
            .e-l { border-left: 5pt solid #000 !important; }
            .e-r { border-right: 5pt solid #000 !important; }

            .pr-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 2mm; border-top: 0.5pt solid #000; padding-top: 1mm; }
            .pr-edge-text { font-size: 7pt; font-weight: normal; max-width: 70%; }
            .pr-tech { font-size: 14pt; }
        }
        
        #print-area { display: none; } /* –°–∫—Ä—ã—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ */
    </style>
</head>
<body>

<div class="header">
    <div class="logo">MUSTAFAYEV <span>ACADEMY</span></div>
    <div style="display: flex; gap: 15px; align-items: center;">
        <div id="stats" style="font-size: 13px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –ø—Ä–æ–µ–∫—Ç–∞</div>
        <input type="file" id="fileInput" style="display:none" accept=".project">
        <button class="btn-load" onclick="document.getElementById('fileInput').click()">–û–¢–ö–†–´–¢–¨ –ü–†–û–ï–ö–¢</button>
    </div>
</div>

<div class="main-container">
    <div id="grid" class="grid"></div>
</div>

<div id="print-area">
    <div class="pr-header">Mustafayev Academy</div>
    <div class="pr-info" id="p-project">–ü—Ä–æ–µ–∫—Ç: -</div>
    <div class="pr-part-name" id="p-name">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–∏</div>
    <div class="pr-info" id="p-material">–ú–∞—Ç–µ—Ä–∏–∞–ª: -</div>
    
    <div id="p-box" class="size-box">
        <span id="p-size-val">0 x 0</span>
    </div>

    <div class="pr-footer">
        <div class="pr-edge-text" id="p-edge-val">–ö—Ä–æ–º–∫–∞: -</div>
        <div class="pr-tech" id="p-icons"></div>
    </div>
</div>

<script>
    let queue = [];
    let currentProject = "";
    let currentMaterial = "";
    let currentEdge = "";

    document.getElementById('fileInput').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(ev) {
            const parser = new DOMParser();
            const xml = parser.parseFromString(ev.target.result, "text/xml");
            
            // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
            currentProject = xml.querySelector("good[typeId='product']")?.getAttribute("name") || "–ó–∞–∫–∞–∑";
            currentMaterial = xml.querySelector("good[typeId='sheet']")?.getAttribute("name") || "–õ–î–°–ü";
            currentEdge = xml.querySelector("good[typeId='band']")?.getAttribute("name") || "–ü–í–•";

            // –ö–∞—Ä—Ç–∞ —Ç–µ—Ö–ø—Ä–æ—Ü–µ—Å—Å–æ–≤
            const tech = {};
            const ops = xml.getElementsByTagName("operation");
            for (let op of ops) {
                if (op.getAttribute("typeId") === "XNC") {
                    const prog = op.getAttribute("program") || "";
                    const hasBore = prog.includes("Bore");
                    const hasMill = prog.includes("Mill") || prog.includes("mac");
                    const refs = op.getElementsByTagName("part");
                    for (let r of refs) {
                        const id = r.getAttribute("id");
                        if (!tech[id]) tech[id] = { b: false, m: false };
                        if (hasBore) tech[id].b = true;
                        if (hasMill) tech[id].m = true;
                    }
                }
            }

            // –û—á–µ—Ä–µ–¥—å –¥–µ—Ç–∞–ª–µ–π
            queue = [];
            const parts = xml.getElementsByTagName("part");
            for (let p of parts) {
                if (p.parentNode.nodeName === "good" && p.hasAttribute("dl")) {
                    const id = p.getAttribute("id");
                    const count = parseInt(p.getAttribute("count")) || 1;
                    for (let c = 0; c < count; c++) {
                        queue.push({
                            id: id,
                            name: p.getAttribute("name"),
                            l: Math.round(parseFloat(p.getAttribute("dl"))),
                            w: Math.round(parseFloat(p.getAttribute("dw"))),
                            edge: {
                                t: p.hasAttribute("elt"), b: p.hasAttribute("elb"),
                                l: p.hasAttribute("ell"), r: p.hasAttribute("elr")
                            },
                            bore: tech[id]?.b || false,
                            mill: tech[id]?.m || false
                        });
                    }
                }
            }
            render();
        };
        reader.readAsText(file, "windows-1251");
    };

    function render() {
        const grid = document.getElementById('grid');
        document.getElementById('stats').innerText = `–î–µ—Ç–∞–ª–µ–π –≤ –æ—á–µ—Ä–µ–¥–∏: ${queue.length}`;
        grid.innerHTML = '';

        queue.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="status-icons">${item.bore ? 'üî©' : ''} ${item.mill ? 'üåÄ' : ''}</div>
                <div class="p-name">${item.name}</div>
                <div class="p-size">${item.l} √ó ${item.w}</div>
                <div style="font-size: 10px; color: var(--accent); margin-top: 10px; font-weight:bold;">–ù–ê–ñ–ú–ò–¢–ï –î–õ–Ø –ü–ï–ß–ê–¢–ò</div>
            `;
            card.onclick = () => startPrint(index);
            grid.appendChild(card);
        });
    }

    function startPrint(index) {
        const item = queue[index];

        // 1. –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä—ã—Ç—É—é –æ–±–ª–∞—Å—Ç—å –ø–µ—á–∞—Ç–∏ –¥–∞–Ω–Ω—ã–º–∏
        document.getElementById('p-project').innerText = "–ü—Ä–æ–µ–∫—Ç: " + currentProject;
        document.getElementById('p-name').innerText = item.name;
        document.getElementById('p-material').innerText = "–ú–∞—Ç: " + currentMaterial;
        document.getElementById('p-size-val').innerText = `${item.l} x ${item.w}`;
        document.getElementById('p-icons').innerText = (item.bore ? 'üî©' : '') + (item.mill ? ' üåÄ' : '');
        
        const hasEdge = (item.edge.t || item.edge.b || item.edge.l || item.edge.r);
        document.getElementById('p-edge-val').innerText = hasEdge ? "–ö—Ä–æ–º–∫–∞: " + currentEdge : "";

        // 2. –†–∏—Å—É–µ–º —Ä–∞–º–∫—É –∫—Ä–æ–º–∫–∏
        const box = document.getElementById('p-box');
        box.className = 'size-box';
        if (item.edge.t) box.classList.add('e-t');
        if (item.edge.b) box.classList.add('e-b');
        if (item.edge.l) box.classList.add('e-l');
        if (item.edge.r) box.classList.add('e-r');

        // 3. –ó–∞–ø—É—Å–∫ –ø–µ—á–∞—Ç–∏
        window.print();

        // 4. –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞
        queue.splice(index, 1);
        render();
    }
</script>

</body>
</html>
