<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Mustafayev Academy | Project Terminal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --panel: #1e293b; --accent: #10b981; --blue: #3b82f6; --text: #f8fafc;
        }
        body {
            font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text);
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }
        header {
            padding: 15px 40px; background: var(--panel); border-bottom: 2px solid var(--accent);
            display: flex; justify-content: space-between; align-items: center;
        }
        .controls { padding: 20px 40px; background: rgba(30, 41, 59, 0.5); display: flex; gap: 20px; align-items: center; }
        .btn-load { background: var(--blue); color: white; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; border: none; }
        
        .workspace { flex: 1; padding: 40px; overflow: auto; display: flex; flex-direction: column; align-items: center; gap: 40px; }
        .sheet-container { position: relative; background: #334155; border: 2px solid #64748b; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        
        .part {
            position: absolute; background: #475569; border: 1px solid rgba(255,255,255,0.3);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.1s; font-size: 11px; box-sizing: border-box;
        }
        .part:hover { background: var(--blue); z-index: 10; transform: scale(1.02); }
        .part.is-cut { background: var(--accent) !important; opacity: 0.5; }

        /* –ö—Ä–æ–º–∫–∞ –Ω–∞ —Å—Ö–µ–º–µ */
        .edge-indicator { position: absolute; background: #ffeb3b; }

        footer { padding: 15px 40px; text-align: right; background: var(--panel); font-size: 18px; }
        footer b { color: var(--accent); }

        @media print {
            .no-print { display: none !important; }
            #print-area { display: block !important; }
            @page { margin: 0; }
        }
        #print-area {
            display: none; width: 80mm; height: 50mm; background: white; color: black;
            padding: 8px; box-sizing: border-box; font-family: Arial, sans-serif;
        }
        .label-grid { display: grid; grid-template-columns: 1fr 95px; height: 100%; border: 1px solid #000; padding: 5px; }
        .edge-map { width: 40px; height: 30px; border: 1px solid #ccc; position: relative; margin: 5px 0; }
        .edge-bold { background: black; position: absolute; }
    </style>
</head>
<body>

<header class="no-print">
    <h1>MUSTAFAYEV FACTORY <span style="font-size: 12px; opacity: 0.6;">| IMPORT .PROJECT</span></h1>
    <div id="clock"></div>
</header>

<div class="controls no-print">
    <label class="btn-load">üì• –ò–ú–ü–û–†–¢ –§–ê–ô–õ–ê –ü–†–û–ï–ö–¢–ê (.PROJECT)
        <input type="file" id="fileInput" style="display:none" onchange="loadProject(event)">
    </label>
    <div id="status" style="color: var(--accent)">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –ø—Ä–æ–µ–∫—Ç–∞ –ë–∞–∑–∏—Å</div>
</div>

<div class="workspace no-print" id="workspace">
    <div style="opacity: 0.2; font-size: 24px; margin-top: 100px;">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∑–∞–≥—Ä—É–∑–∫–µ .project</div>
</div>

<footer class="no-print">Mustafayev <b>Academy</b></footer>

<div id="print-area">
    <div class="label-grid">
        <div class="label-info">
            <div style="font-size: 7pt; font-weight: bold;">MUSTAFAYEV ACADEMY</div>
            <div id="p-name" style="font-size: 11pt; margin-top: 2px;">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</div>
            <div id="p-size" style="font-size: 18pt; font-weight: 900; margin: 2px 0;">000 x 000</div>
            <div id="p-mat" style="font-size: 8pt; height: 24px; overflow: hidden;">–ú–∞—Ç–µ—Ä–∏–∞–ª</div>
            
            <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                <div class="edge-map" id="edge-visual">
                    </div>
                <div style="font-size: 7pt;" id="edge-text">–ö—Ä–æ–º–∫–∞: -</div>
            </div>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;">
            <div id="qrcode"></div>
            <div id="p-id" style="font-size: 8pt; font-weight: bold;">ID: 000</div>
        </div>
    </div>
</div>

<script>
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleString(); }, 1000);

    const SCALE = 0.3;

    async function loadProject(event) {
        const file = event.target.files[0];
        if (!file) return;

        document.getElementById('status').innerText = "–ó–∞–≥—Ä—É–∑–∫–∞: " + file.name;
        const text = await file.text();
        
        // –í .project –¥–∞–Ω–Ω—ã–µ —á–∞—Å—Ç–æ —É–ø–∞–∫–æ–≤–∞–Ω—ã –∫–∞–∫ XML –∏–ª–∏ JSON –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–µ—Ä—Å–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
        // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä
        parseProjectData(text);
    }

    function parseProjectData(content) {
        const workspace = document.getElementById('workspace');
        workspace.innerHTML = '';
        
        // –ü–æ–∏—Å–∫ –ø–∞–Ω–µ–ª–µ–π –∏ –∏—Ö —Å–≤–æ–π—Å—Ç–≤ —á–µ—Ä–µ–∑ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è .project)
        const panelMatches = [...content.matchAll(/<panel.*?material="(.*?)".*?l="(.*?)".*?w="(.*?)".*?>(.*?)<\/panel/gs)];
        
        if (panelMatches.length === 0) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å–∫—Ä–æ—è –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –ø—Ä–æ–µ–∫—Ç —Å –∫–∞—Ä—Ç–∞–º–∏ —Ä–∞—Å–∫—Ä–æ—è.");
            return;
        }

        panelMatches.forEach((match, idx) => {
            const [full, material, L, W, inner] = match;
            
            const sheet = document.createElement('div');
            sheet.className = 'sheet-container';
            sheet.style.width = (L * SCALE) + 'px';
            sheet.style.height = (W * SCALE) + 'px';
            sheet.innerHTML = `<div style="position:absolute; top:-25px; color:var(--accent)">–ü–õ–ò–¢–ê ${idx+1}: ${material}</div>`;

            // –ü–æ–∏—Å–∫ –¥–µ—Ç–∞–ª–µ–π –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ –ø–∞–Ω–µ–ª–∏
            const partMatches = [...inner.matchAll(/<no\..*?l="(.*?)".*?w="(.*?)".*?x="(.*?)".*?y="(.*?)".*?id="(.*?)".*?>/gs)];
            
            partMatches.forEach(pMatch => {
                const [pFull, pL, pW, pX, pY, pId] = pMatch;
                
                const div = document.createElement('div');
                div.className = 'part';
                div.style.left = (pX * SCALE) + 'px';
                div.style.top = (pY * SCALE) + 'px';
                div.style.width = (pL * SCALE) + 'px';
                div.style.height = (pW * SCALE) + 'px';
                
                if (pL * SCALE > 40) div.innerHTML = `<b>${pL}</b><br>${pW}`;

                div.onclick = () => {
                    div.classList.add('is-cut');
                    generateSmartLabel({
                        name: "–î–µ—Ç–∞–ª—å #" + pId,
                        size: pL + " x " + pW,
                        material: material,
                        id: pId,
                        // –í —Ä–µ–∞–ª—å–Ω–æ–º .project –∫—Ä–æ–º–∫–∞ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º —Å—Ç–æ—Ä–æ–Ω
                        edges: { t: true, b: false, l: true, r: false } 
                    });
                };
                sheet.appendChild(div);
            });
            workspace.appendChild(sheet);
        });
    }

    function generateSmartLabel(data) {
        document.getElementById('p-name').innerText = data.name;
        document.getElementById('p-size').innerText = data.size;
        document.getElementById('p-mat').innerText = data.material;
        document.getElementById('p-id').innerText = "ID: " + data.id;

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫—Ä–æ–º–∫–∏ –Ω–∞ –±–∏—Ä–∫–µ
        const ev = document.getElementById('edge-visual');
        ev.innerHTML = '';
        if(data.edges.t) ev.innerHTML += '<div class="edge-bold" style="top:0; left:0; width:100%; height:3px;"></div>';
        if(data.edges.b) ev.innerHTML += '<div class="edge-bold" style="bottom:0; left:0; width:100%; height:3px;"></div>';
        if(data.edges.l) ev.innerHTML += '<div class="edge-bold" style="top:0; left:0; width:3px; height:100%;"></div>';
        if(data.edges.r) ev.innerHTML += '<div class="edge-bold" style="top:0; right:0; width:3px; height:100%;"></div>';

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR
        const qrBox = document.getElementById('qrcode');
        qrBox.innerHTML = '';
        new QRCode(qrBox, {
            text: `PROJ_ID:${data.id}|${data.size}`,
            width: 85, height: 85
        });

        setTimeout(() => { window.print(); }, 300);
    }
</script>
</body>
</html>
