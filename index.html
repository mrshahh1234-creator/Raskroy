<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>GibLab: Очередь печати</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        .header { background: #252525; padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid var(--accent); }
        .btn-load { background: var(--accent); color: white; border: none; padding: 12px 25px; cursor: pointer; font-weight: bold; border-radius: 5px; }
        
        /* Сетка деталей */
        .queue-container { 
            flex: 1; 
            padding: 20px; 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
            gap: 15px; 
            align-content: start;
            overflow-y: auto; 
        }

        /* Карточка детали */
        .part-card { 
            background: var(--card); 
            border: 1px solid #333; 
            padding: 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: transform 0.2s, background 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .part-card:hover { background: #2a2a2a; transform: translateY(-3px); border-color: var(--accent); }
        .part-card:active { transform: scale(0.95); }

        .part-name { font-size: 14px; color: #aaa; margin-bottom: 8px; text-align: center; }
        .part-size { font-size: 28px; font-weight: bold; color: #fff; }
        .part-mat { font-size: 12px; color: #666; margin-top: 10px; }

        /* Номер в очереди */
        .part-badge { position: absolute; top: 10px; left: 10px; background: #333; padding: 2px 8px; border-radius: 10px; font-size: 10px; }

        /* Этикетка для принтера */
        #label-print { display: none; }
        @media print {
            body * { display: none; }
            #label-print { 
                display: block !important; 
                color: black; 
                width: 58mm; 
                text-align: center; 
                padding: 5mm; 
                font-family: Arial; 
            }
            .p-size { font-size: 22pt; font-weight: bold; }
        }
    </style>
</head>
<body>

<div class="header">
    <div style="font-size: 22px; font-weight: bold;">GIBLAB <span style="color:var(--accent)">QUEUE</span></div>
    <div>
        <input type="file" id="fileInput" style="display:none" accept=".project">
        <button class="btn-load" onclick="document.getElementById('fileInput').click()">ЗАГРУЗИТЬ ЗАКАЗ</button>
    </div>
    <div id="counter">Деталей: 0</div>
</div>

<div class="queue-container" id="queue">
    </div>

<div id="label-print">
    <div id="lbl-name" style="font-size: 12pt;">Наименование</div>
    <div id="lbl-size" class="p-size">000 x 000</div>
    <div id="lbl-mat" style="font-size: 9pt; margin-top: 5px;">Материал</div>
    <div style="margin-top: 10px; font-size: 8pt; border-top: 1px solid #000; padding-top: 5px;">GibLab Export System</div>
</div>

<script>
    let partsQueue = [];

    document.getElementById('fileInput').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const data = JSON.parse(event.target.result);
                parseData(data);
            } catch (err) {
                alert("Ошибка в файле .project");
            }
        };
        reader.readAsText(file);
    };

    function parseData(data) {
        partsQueue = [];
        if (data.opCutSheets) {
            data.opCutSheets.forEach(sheet => {
                sheet.parts.forEach(p => {
                    partsQueue.push({
                        id: Math.random().toString(36).substr(2, 9),
                        name: p.Name || "Без названия",
                        w: Math.round(p.Width || 0),
                        h: Math.round(p.Height || 0),
                        mat: sheet.MaterialName || "ЛДСП"
                    });
                });
            });
        }
        renderQueue();
    }

    function renderQueue() {
        const container = document.getElementById('queue');
        const counter = document.getElementById('counter');
        container.innerHTML = '';
        counter.innerText = `Осталось: ${partsQueue.length}`;

        partsQueue.forEach((part, index) => {
            const card = document.createElement('div');
            card.className = 'part-card';
            card.innerHTML = `
                <div class="part-badge">${index + 1}</div>
                <div class="part-name">${part.name}</div>
                <div class="part-size">${part.w} × ${part.h}</div>
                <div class="part-mat">${part.mat}</div>
            `;
            card.onclick = () => processPart(index);
            container.appendChild(card);
        });
    }

    function processPart(index) {
        const part = partsQueue[index];
        
        // 1. Подготовка этикетки
        document.getElementById('lbl-name').innerText = part.name;
        document.getElementById('lbl-size').innerText = `${part.w} × ${part.h}`;
        document.getElementById('lbl-mat').innerText = part.mat;

        // 2. Печать
        window.print();

        // 3. Удаление из очереди
        partsQueue.splice(index, 1);

        // 4. Перерисовка (следующая деталь займет место)
        renderQueue();
    }
</script>

</body>
</html>
