<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mustafayev Academy | Production Control</title>
    <style>
        :root { 
            --accent: #2ecc71; 
            --accent-dark: #27ae60;
            --bg: #0f1215; 
            --card-bg: #1c2227; 
            --text-main: #e0e6ed;
            --text-dim: #94a3b8;
        }

        body { 
            font-family: 'Inter', 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text-main); 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
        }

        /* Header Area */
        .header { 
            background: rgba(26, 32, 39, 0.95); 
            backdrop-filter: blur(10px);
            padding: 15px 30px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            border-bottom: 2px solid var(--accent);
            z-index: 100;
        }

        .logo-group { display: flex; align-items: center; gap: 12px; }
        .logo-icon { background: var(--accent); color: #000; padding: 5px 8px; border-radius: 6px; font-weight: 900; }
        .logo-text { font-size: 18px; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; }
        .logo-text span { color: var(--accent); }

        .btn-load { 
            background: var(--accent); 
            color: #0d1117; 
            border: none; 
            padding: 12px 24px; 
            font-size: 14px;
            font-weight: 700; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-load:hover { background: #fff; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4); }

        /* Dashboard Statistics */
        .stats-bar { padding: 10px 30px; background: #161b22; font-size: 13px; color: var(--text-dim); display: flex; gap: 20px; border-bottom: 1px solid #30363d; }
        .stat-item b { color: var(--accent); }

        /* Grid */
        .main-view { flex: 1; padding: 25px; overflow-y: auto; scroll-behavior: smooth; }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; 
        }

        /* Industrial Card Design */
        .card { 
            background: var(--card-bg); 
            border: 1px solid #30363d; 
            border-radius: 12px; 
            padding: 20px; 
            cursor: pointer; 
            position: relative; 
            transition: 0.2s;
            overflow: hidden;
        }
        .card:hover { 
            border-color: var(--accent); 
            background: #212830;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .card::before {
            content: ""; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: transparent; transition: 0.2s;
        }
        .card:hover::before { background: var(--accent); }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .p-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
        .p-name { font-size: 15px; font-weight: 600; color: #fff; line-height: 1.4; margin-top: 4px; }
        .p-size { font-size: 34px; font-weight: 800; color: var(--text-main); margin: 10px 0; font-variant-numeric: tabular-nums; }
        
        .badge-container { display: flex; gap: 8px; margin-top: 15px; }
        .badge { font-size: 10px; padding: 4px 8px; border-radius: 4px; background: #2d333b; color: #adbac7; font-weight: bold; }
        .badge.active { background: rgba(46, 204, 113, 0.15); color: var(--accent); border: 1px solid rgba(46, 204, 113, 0.3); }

        /* Print Template (Hidden) */
        #print-area { display: none; }

        @media print {
            body * { display: none !important; }
            #print-area { 
                display: block !important; 
                width: 58mm; 
                margin: 0; 
                padding: 4mm; 
                color: #000 !important; 
                background: #fff !important;
                font-family: 'Arial', sans-serif;
            }
            .pr-title { font-size: 12pt; font-weight: 900; text-align: center; border-bottom: 2pt solid #000; padding-bottom: 3px; margin-bottom: 5px; }
            .pr-row { font-size: 8pt; margin: 2px 0; }
            .pr-name { font-size: 11pt; font-weight: bold; margin: 5px 0; line-height: 1.2; }
            .size-box { 
                border: 2pt solid #eee; margin: 8px 0; padding: 8px; text-align: center; font-size: 26pt; font-weight: bold; 
                position: relative;
            }
            /* Visual Edge Banding on Label */
            .e-t { border-top: 6pt solid #000 !important; }
            .e-b { border-bottom: 6pt solid #000 !important; }
            .e-l { border-left: 6pt solid #000 !important; }
            .e-r { border-right: 6pt solid #000 !important; }

            .pr-footer { display: flex; justify-content: space-between; border-top: 1pt solid #000; padding-top: 5px; margin-top: 5px; font-size: 9pt; font-weight: bold; }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="logo-group">
        <div class="logo-icon">M</div>
        <div class="logo-text">Mustafayev <span>Academy</span></div>
    </div>
    <div style="display: flex; gap: 15px;">
        <input type="file" id="fileInput" style="display:none" accept=".project">
        <button class="btn-load" onclick="document.getElementById('fileInput').click()">
            <span>üìÇ</span> –ó–ê–ì–†–£–ó–ò–¢–¨ –ü–†–û–ï–ö–¢
        </button>
    </div>
</div>

<div class="stats-bar" id="stats-bar">
    <div class="stat-item">–ü—Ä–æ–µ–∫—Ç: <b id="stat-proj">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</b></div>
    <div class="stat-item">–ú–∞—Ç–µ—Ä–∏–∞–ª: <b id="stat-mat">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</b></div>
    <div class="stat-item">–û—á–µ—Ä–µ–¥—å: <b id="stat-count">0 —à—Ç.</b></div>
</div>

<div class="main-view">
    <div id="grid" class="grid">
        </div>
</div>

<div id="print-area">
    <div class="pr-title">MUSTAFAYEV ACADEMY</div>
    <div class="pr-row" style="font-style: italic" id="p-proj-name">–ü—Ä–æ–µ–∫—Ç</div>
    <div class="pr-name" id="p-part-name">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–∏</div>
    <div class="pr-row" id="p-mat-name">–ú–∞—Ç–µ—Ä–∏–∞–ª</div>
    
    <div id="p-size-box" class="size-box">
        <span id="p-dims">0 x 0</span>
    </div>

    <div class="pr-footer">
        <div id="p-icons"></div>
        <div id="p-edge-label" style="font-size: 7pt; text-align: right;"></div>
    </div>
</div>

<script>
    let queue = [];
    let projectTitle = "";
    let mainMaterial = "";
    let edgeMaterial = "";

    document.getElementById('fileInput').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(ev) {
            const parser = new DOMParser();
            const xml = parser.parseFromString(ev.target.result, "text/xml");
            
            projectTitle = xml.querySelector("good[typeId='product']")?.getAttribute("name") || "–ù–æ–≤—ã–π –∑–∞–∫–∞–∑";
            mainMaterial = xml.querySelector("good[typeId='sheet']")?.getAttribute("name") || "–õ–î–°–ü";
            edgeMaterial = xml.querySelector("good[typeId='band']")?.getAttribute("name") || "–°—Ç–∞–Ω–¥–∞—Ä—Ç";

            // –°–æ–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç—É —Ç–µ—Ö–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–°–≤–µ—Ä–ª–µ–Ω–∏–µ/–§—Ä–µ–∑–∞)
            const techMap = {};
            const operations = xml.getElementsByTagName("operation");
            for (let op of operations) {
                if (op.getAttribute("typeId") === "XNC") {
                    const prog = op.getAttribute("program") || "";
                    const hasBore = prog.includes("Bore");
                    const hasMill = prog.includes("Mill") || prog.includes("mac");
                    
                    const partRefs = op.getElementsByTagName("part");
                    for (let ref of partRefs) {
                        const pid = ref.getAttribute("id");
                        if (!techMap[pid]) techMap[pid] = { b: false, m: false };
                        if (hasBore) techMap[pid].b = true;
                        if (hasMill) techMap[pid].m = true;
                    }
                }
            }

            queue = [];
            const parts = xml.getElementsByTagName("part");
            for (let p of parts) {
                if (p.parentNode.nodeName === "good" && p.hasAttribute("dl")) {
                    const count = parseInt(p.getAttribute("count")) || 1;
                    const id = p.getAttribute("id");
                    for (let c = 0; c < count; c++) {
                        queue.push({
                            id: id,
                            name: p.getAttribute("name"),
                            l: Math.round(parseFloat(p.getAttribute("dl"))),
                            w: Math.round(parseFloat(p.getAttribute("dw"))),
                            edge: {
                                t: p.hasAttribute("elt"), b: p.hasAttribute("elb"),
                                l: p.hasAttribute("ell"), r: p.hasAttribute("elr")
                            },
                            bore: techMap[id]?.b || false,
                            mill: techMap[id]?.m || false
                        });
                    }
                }
            }
            updateStats();
            render();
        };
        reader.readAsText(file, "windows-1251");
    };

    function updateStats() {
        document.getElementById('stat-proj').innerText = projectTitle;
        document.getElementById('stat-mat').innerText = mainMaterial;
        document.getElementById('stat-count').innerText = queue.length + ' —à—Ç.';
    }

    function render() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';

        if (queue.length === 0) {
            grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 100px; opacity: 0.3;">
                <h1 style="font-size: 60px;">üì¶</h1>
                <p>–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª .project</p>
            </div>`;
            return;
        }

        queue.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-header">
                    <div class="p-label">–î–µ—Ç–∞–ª—å #${index + 1}</div>
                    <div style="font-size: 18px;">${item.bore ? '‚öôÔ∏è' : ''} ${item.mill ? 'üåÄ' : ''}</div>
                </div>
                <div class="p-name">${item.name}</div>
                <div class="p-size">${item.l} <span style="color:var(--accent); font-size:20px;">√ó</span> ${item.w}</div>
                <div class="badge-container">
                    <div class="badge ${item.bore ? 'active' : ''}">–ü–†–ò–°–ê–î–ö–ê</div>
                    <div class="badge ${item.mill ? 'active' : ''}">–§–†–ï–ó–ê</div>
                    <div class="badge ${(item.edge.t || item.edge.b || item.edge.l || item.edge.r) ? 'active' : ''}">–ö–†–û–ú–ö–ê</div>
                </div>
            `;
            card.onclick = () => printDetail(index);
            grid.appendChild(card);
        });
    }

    function printDetail(index) {
        const item = queue[index];

        // –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –ø–µ—á–∞—Ç–∏
        document.getElementById('p-proj-name').innerText = projectTitle;
        document.getElementById('p-part-name').innerText = item.name;
        document.getElementById('p-mat-name').innerText = mainMaterial;
        document.getElementById('p-dims').innerText = `${item.l} x ${item.w}`;
        document.getElementById('p-icons').innerText = (item.bore ? 'üî© ' : '') + (item.mill ? 'üåÄ' : '');
        
        const isEdged = (item.edge.t || item.edge.b || item.edge.l || item.edge.r);
        document.getElementById('p-edge-label').innerText = isEdged ? edgeMaterial : '–ë–µ–∑ –∫—Ä–æ–º–∫–∏';

        // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∫—Ä–æ–º–∫–∏ (–≥—Ä–∞–Ω–∏—Ü—ã –±–æ–∫—Å–∞)
        const box = document.getElementById('p-size-box');
        box.className = 'size-box';
        if (item.edge.t) box.classList.add('e-t');
        if (item.edge.b) box.classList.add('e-b');
        if (item.edge.l) box.classList.add('e-l');
        if (item.edge.r) box.classList.add('e-r');

        // –í—ã–∑–æ–≤ –ø–µ—á–∞—Ç–∏
        window.print();

        // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
        queue.splice(index, 1);
        updateStats();
        render();
    }
</script>

</body>
</html>
