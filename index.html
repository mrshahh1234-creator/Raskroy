<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>GibLab Web PRO | Nanxing ND510S</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        :root { --nx-blue: #0054a6; --nx-red: #e30613; --bg: #f4f7f9; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma; display: flex; height: 100vh; background: var(--bg); }
        
        .sidebar { width: 250px; background: #2c3e50; color: white; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .logo-box { background: white; padding: 10px; border-radius: 4px; text-align: center; margin-bottom: 10px; }
        .logo-text { color: var(--nx-blue); font-weight: 900; font-size: 24px; line-height: 1; }
        
        .btn { background: var(--nx-blue); border: none; color: white; padding: 12px; cursor: pointer; border-radius: 4px; font-weight: bold; text-align: left; transition: 0.2s; }
        .btn:hover { background: #004488; transform: translateX(5px); }
        .btn-import { background: #8e44ad; border: 2px solid #ab62cf; }
        .btn-calc { background: #27ae60; font-size: 14px; text-align: center; margin-top: 10px; }

        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .tabs { background: #dee2e6; display: flex; padding: 8px 10px 0; border-bottom: 1px solid #ced4da; }
        .tab { padding: 10px 20px; cursor: pointer; background: #ced4da; margin-right: 5px; border-radius: 6px 6px 0 0; border: 1px solid #adb5bd; border-bottom: none; }
        .tab.active { background: white; font-weight: bold; color: var(--nx-blue); }

        .content { flex: 1; overflow-y: auto; background: white; padding: 20px; }
        table { width: 100%; border-collapse: collapse; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th { background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; font-size: 13px; text-align: center; sticky: top; }
        td { border: 1px solid #dee2e6; padding: 8px; text-align: center; font-size: 13px; }

        /* –≠—Ç–∏–∫–µ—Ç–∫–∞ */
        .label-card { width: 80mm; height: 50mm; border: 2px solid #000; padding: 10px; margin: 10px; display: inline-block; position: relative; vertical-align: top; background: white; }
        .label-qr { position: absolute; bottom: 5px; right: 5px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo-box">
        <div class="logo-text">NANXING</div>
        <div style="color:var(--nx-red); font-size:9px; font-weight:bold;">ND510S CONTROL</div>
    </div>

    <button class="btn btn-import" onclick="document.getElementById('fileInput').click()">üì• –ó–ê–ì–†–£–ó–ò–¢–¨ .PROJECT</button>
    <input type="file" id="fileInput" style="display:none" accept=".project" onchange="handleFile(event)">
    
    <button class="btn" onclick="downloadProject()">üíæ –°–û–•–†–ê–ù–ò–¢–¨ –ü–†–û–ï–ö–¢</button>
    <button class="btn btn-calc" onclick="switchTab('labels')">‚öôÔ∏è –ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨ –≠–¢–ò–ö–ï–¢–ö–ò</button>
    <button class="btn" onclick="exportSawXML()" style="background:#e67e22">üõí –í–´–ì–†–£–ó–ò–¢–¨ –ù–ê –°–¢–ê–ù–û–ö</button>
</div>

<div class="main">
    <div class="tabs">
        <div id="t-parts" class="tab active" onclick="switchTab('parts')">–°–ø–∏—Å–æ–∫ –¥–µ—Ç–∞–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞</div>
        <div id="t-labels" class="tab" onclick="switchTab('labels')">–≠—Ç–∏–∫–µ—Ç–∫–∏ –¥–ª—è –ø—Ä–∏—Å–∞–¥–∫–∏</div>
    </div>

    <div id="sec-parts" class="content">
        <h2 id="projName">–ü—Ä–æ–µ–∫—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                    <th>–î–ª–∏–Ω–∞ (L)</th>
                    <th>–®–∏—Ä–∏–Ω–∞ (W)</th>
                    <th>–ö–æ–ª-–≤–æ</th>
                    <th>–ö–æ–¥ –æ–ø–µ—Ä–∞—Ü–∏–∏</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="6">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª .project –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</td></tr>
            </tbody>
        </table>
    </div>

    <div id="sec-labels" class="content" style="display:none">
        <div id="labelsGrid"></div>
    </div>
</div>

<script>
    let currentParts = [];
    let projectName = "";

    // –§—É–Ω–∫—Ü–∏—è —á—Ç–µ–Ω–∏—è —Ç–≤–æ–µ–≥–æ —Ñ–∞–π–ª–∞ .project
    function handleFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
            
            // –ù–∞—Ö–æ–¥–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ (–ì–∞—Ä–¥–µ—Ä–æ–±)
            const goodTag = xmlDoc.getElementsByTagName("good")[0];
            projectName = goodTag ? goodTag.getAttribute("name") : "–ü—Ä–æ–µ–∫—Ç";
            document.getElementById('projName').innerText = "–ü—Ä–æ–µ–∫—Ç: " + projectName;

            // –ü–∞—Ä—Å–∏–º –¥–µ—Ç–∞–ª–∏
            const partTags = xmlDoc.getElementsByTagName("part");
            currentParts = [];

            for (let i = 0; i < partTags.length; i++) {
                currentParts.push({
                    id: partTags[i].getAttribute("id"),
                    name: partTags[i].getAttribute("name"),
                    l: partTags[i].getAttribute("dl"),
                    w: partTags[i].getAttribute("dw"),
                    count: partTags[i].getAttribute("count") || 1,
                    code: partTags[i].getAttribute("code") || "Standard"
                });
            }
            renderTable();
            alert("–§–∞–π–ª " + file.name + " —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω. –ù–∞–π–¥–µ–Ω–æ –¥–µ—Ç–∞–ª–µ–π: " + currentParts.length);
        };
        reader.readAsText(file);
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        currentParts.forEach(p => {
            tbody.innerHTML += `<tr>
                <td>${p.id}</td>
                <td>${p.name}</td>
                <td><b>${p.l}</b></td>
                <td><b>${p.w}</b></td>
                <td>${p.count}</td>
                <td>${p.code}</td>
            </tr>`;
        });
    }

    function switchTab(tab) {
        document.getElementById('sec-parts').style.display = tab === 'parts' ? 'block' : 'none';
        document.getElementById('sec-labels').style.display = tab === 'labels' ? 'block' : 'none';
        document.getElementById('t-parts').className = tab === 'parts' ? 'tab active' : 'tab';
        document.getElementById('t-labels').className = tab === 'labels' ? 'tab active' : 'tab';
        if (tab === 'labels') renderLabels();
    }

    function renderLabels() {
        const grid = document.getElementById('labelsGrid');
        grid.innerHTML = '';
        currentParts.forEach((p, idx) => {
            for (let i = 0; i < p.count; i++) {
                const labelId = `qr-${idx}-${i}`;
                const div = document.createElement('div');
                div.className = 'label-card';
                div.innerHTML = `
                    <div style="font-weight:bold; border-bottom:1px solid #000; font-size:10px; display:flex; justify-content:space-between">
                        <span>NANXING ND510S</span> <span>${i+1}/${p.count}</span>
                    </div>
                    <div style="margin-top:5px; font-size:12px;">${p.name}</div>
                    <div style="font-size:20px; font-weight:900; margin:5px 0;">${p.l} x ${p.w}</div>
                    <div style="font-size:9px; color:#555;">ID: ${p.id} | Code: ${p.code}</div>
                    <div id="${labelId}" class="label-qr"></div>
                `;
                grid.appendChild(div);
                // –í QR-–∫–æ–¥–µ –∑–∞—à–∏–≤–∞–µ–º ID –∏ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è —Å–∫–∞–Ω–µ—Ä–∞ ND510S
                new QRCode(document.getElementById(labelId), {
                    text: `ID${p.id}_${p.l}x${p.w}`,
                    width: 64, height: 64
                });
            }
        });
    }

    // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –æ–±—Ä–∞—Ç–Ω–æ –≤ .project (JSON-–≤–µ—Ä—Å–∏—è)
    function downloadProject() {
        const data = JSON.stringify({projectName, parts: currentParts}, null, 2);
        const blob = new Blob([data], {type: "application/octet-stream"});
        saveAs(blob, projectName + ".project");
    }

    // –í—ã–≥—Ä—É–∑–∫–∞ XML –¥–ª—è –ø–∏–ª—å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ Nanxing
    function exportSawXML() {
        let xml = `<?xml version="1.0" encoding="UTF-8"?><Job Name="${projectName}">`;
        currentParts.forEach(p => {
            xml += `<Part Name="${p.name}" Length="${p.l}" Width="${p.w}" Quantity="${p.count}" />`;
        });
        xml += `</Job>`;
        const blob = new Blob([xml], {type: "text/xml"});
        saveAs(blob, "To_Nanxing_Saw.xml");
    }
</script>
</body>
</html>
